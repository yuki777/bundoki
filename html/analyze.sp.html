<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title><?php echo SITE_NAME; ?></title>
        <meta name="description" content="あなたのツイートからゴキゲン度合いを分析して表示します">
        <meta name="author" content="<?php echo SITE_AUTHOR; ?>">

        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.css" />
        <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.js"></script>

        <link rel="shortcut icon" href="/images/favicon.ico">
        <link rel="apple-touch-icon" href="/images/tora57x57.jpg">
        <link rel="apple-touch-icon" sizes="72x72" href="/images/tora72x72.jpg">
        <link rel="apple-touch-icon" sizes="114x114" href="/images/tora114x114.jpg">

        <!-- loading animation jquery plugin -->
        <!-- http://neteye.github.com/activity-indicator.html -->
        <script src="/js/loading/jquery.activity-indicator-1.0.0.js" /></script>
        <style type="text/css">
        .loading {
            width: 200;
            height: 200;
            float: left;
            margin: 10px;
            padding: 10px 10px;
            color: #000;
            background: whiteSmoke;
            font-family: Helvetica, Arial, Sans-Serif;
        }
        </style>
        <!-- loading animation jquery plugin -->
    </head>

    <body>
        <div data-role="page">

            <div data-role="header">
                <h1><?php echo SITE_NAME; ?></h1>
            </div>

            <div data-role="content">   
                <!-- ローディングアニメーション -->
                <div id="loading"></div>

                <!-- 結果メッセージ -->
                <div id="message"></div>

                <!-- tweetしよう -->
                <div id="lets_tweet"></div>

                <!-- ツイートリスト -->
                <div id="status_list">
                    <ul>
                    </ul>
                </div>

            </div>

            <div data-role="footer"><h4>&copy; <?php echo SITE_URL;?> 2011</h4></div>
        </div>

        <?php include('html/google_analytics.html'); ?>

        <script>
            $(document).ready(function () {
                // ローディングアニメーションstart
                $('#loading').activity({segments: 12, width: 5.5, space: 6, length: 13, color: '#252525', speed: 5.5});
                // ツイートリスト取得
                get_status_list();
                //setTimeout( function() { ... }, 0);
            });

            function get_status_list(){
                var xhr = new XMLHttpRequest();
                var url = '/proxy/mode/get_status_list/screen_name/' + "<?php echo $screen_name;?>" + '/datetime/' + "<?php echo $datetime;?>" + '/';
                // 取得完了したら
                xhr.addEventListener("load", function(e) {
                    var status_list = $.parseJSON(sessionStorage.getItem('status_list'));
                    for(var i in status_list.body) {
                        // 各ツイートの感情を取得
                        get_emotion(status_list.body[i]);
                        // html更新
                        $("#status_list ul").append('<li><div id="emotion_'+status_list.body[i]['key']+'"><div id="emotion_type_'+status_list.body[i]['key']+'"></div>' + status_list.body[i]['text'] + '</div></li>');
                    }
                }, false);
                xhr.open('GET', url, true);
                xhr.onreadystatechange = function() {
                    if(xhr.readyState === 4 && xhr.status == 200) {
                        // $.parseJSON(), JSON.stringify()
                        // sessionStorageにいれておく
                        sessionStorage.setItem('status_list', xhr.responseText);
                    }
                };
                xhr.send(null);
            }

            var get_emotion = (function(){
                // 使いまわしたいのでここで宣言。クロージャ
                var i = 0;
                var emotion_list = [];

                return function(status){
                    //if(! status) return null;
                    var xhr = new XMLHttpRequest();
                    var url = '/proxy/mode/get_emotion/status/';
                    // 1ツイートの取得が完了したら
                    xhr.addEventListener("load", function(e) {
                        //var emotion_list = sessionStorage.getItem('emotion_list');
                        //var emotion = xhr.responseText;
                        //emotion_list.push;
                        var json = JSON.parse(xhr.responseText);
                        //console.debug(json.body['emotion_type']);
                        //emotion_list[i] = JSON.stringify(json.body);
                        emotion_list[i] = (json.body);
                        // 20回目なら(完了のはず)
                        if(i==20){
                            // ローディングアニメーションstop
                            $('#loading').activity(false);
                            // メッセージ表示
                            $('#message').html('<p>' + "<?php echo $screen_name; ?>" + 'さんの、positiveをn,negativeをn,unknownをn,検知しました</p>');
                            // ツイートshareしようリンク
                            var link = "https://twitter.com/intent/tweet?text=+...+";
                            $('#lets_tweet').html('<p><a target="_brank" href="'+link+'">結果をTwitterでつぶやこう</a></p>');
                            //var list = sessionStorage.getItem('emotion_list');
                            console.debug(emotion_list);
                        }
                    }, false);
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    xhr.onreadystatechange = function() {
                        if(xhr.readyState === 4 && xhr.status == 200) {
                            sessionStorage.setItem('emotion.' + status['key'], xhr.responseText);
                            var emotion = $.parseJSON(sessionStorage.getItem('emotion.' + status['key']));
                            $("#emotion_type_"+status['key']).html(emotion.body['emotion_type']);
                            i++;
                        }
                    };
                    xhr.send("mode=get_motion&status=" + encodeURI(status['text']));
                }
            })();
        </script>
    </body>
</html>
