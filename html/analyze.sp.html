<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title><?php echo SITE_NAME; ?></title>
        <meta name="description" content="あなたのツイートからゴキゲン度合いを分析して表示します">
        <meta name="author" content="<?php echo SITE_AUTHOR; ?>">

        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.css" />
        <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.js"></script>

        <link rel="shortcut icon" href="/images/favicon.ico">
        <link rel="apple-touch-icon" href="/images/tora57x57.jpg">
        <link rel="apple-touch-icon" sizes="72x72" href="/images/tora72x72.jpg">
        <link rel="apple-touch-icon" sizes="114x114" href="/images/tora114x114.jpg">

        <!-- loading animation jquery plugin -->
        <!-- http://neteye.github.com/activity-indicator.html -->
        <script src="/js/loading/jquery.activity-indicator-1.0.0.js" /></script>
        <style type="text/css">
        .loading {
            width: 200;
            height: 200;
            float: left;
            margin: 10px;
            padding: 10px 10px;
            color: #000;
            background: whiteSmoke;
            font-family: Helvetica, Arial, Sans-Serif;
        }
        </style>
        <!-- loading animation jquery plugin -->
    </head>

    <body>
        <div data-role="page">

            <div data-role="header">
                <h1><?php echo SITE_NAME; ?></h1>
            </div>

            <div data-role="content">   
                <!-- ローディングアニメーション -->
                <div id="loading"></div>

                <!-- 結果メッセージ -->
                <div id="message"></div>

                <!-- tweetしよう -->
                <div id="lets_tweet"></div>

                <!-- ツイートリスト -->
                <div id="status_list">
                    <ul>
                    </ul>
                </div>

            </div>

            <div data-role="footer"><h4>&copy; <?php echo SITE_URL;?> 2011</h4></div>
        </div>

        <?php include('html/google_analytics.html'); ?>

        <script>
            $(document).ready(function () {
                sessionStorage.clear();
                // ローディングアニメーションstart
                $('#loading').activity({segments: 12, width: 5.5, space: 6, length: 13, color: '#252525', speed: 5.5});
                // ツイートリスト取得
                get_status_list();
                //setTimeout( function() { ... }, 0);
            });

            function get_status_list(){
                var url = '/proxy/mode/get_status_list/screen_name/' + "<?php echo $screen_name;?>" + '/datetime/' + "<?php echo $datetime;?>" + '/';
                $.ajax({
                    url : url,
                    type : 'get',
                    dataType : 'json',
                    timeout : 20000,
                    tryCount : 0,
                    retryLimit : 3,
                    success : function(json) {
                        // json objectをsessionStorageで使うにはJSON.stringify()でいれて、JSON.parse()で取り出す
                        sessionStorage.setItem('status_list', JSON.stringify(json));
                        for(var i in json.body) {
                            // 各ツイートの感情を取得
                            get_emotion(json.body[i]);
                            // html更新
                            $("#status_list ul").append('<li><div id="emotion_'+json.body[i]['key']+'"><div id="emotion_type_'+json.body[i]['key']+'"></div>' + json.body[i]['text'] + '</div></li>');
                        }
                    },
                    error : function(xhr, textStatus, errorThrown ){
                        if(textStatus == 'timeout'){
                            this.tryCount++;
                            if(this.tryCount <= this.retryLimit){
                                //try again
                                $.ajax(this);
                                return;
                            }
                            console.debug('We have tried ' + this.retryLimit + ' times and it is still not working. We give in. Sorry.');
                            return;
                        }
                        if(xhr.status == 500){
                            console.debug('Oops! 500.');
                            }else if(xhr.status == 404){
                            console.debug('Oops! 404.');
                            }else{
                            console.debug('Oops! There was a problem, sorry.');
                        }
                    }
                });
            }

            var get_emotion = (function(){
                // 使いまわしたいのでここで宣言。クロージャ
                var i = 0;
                var x = 0;
                var emotion_list = [];
                var status_list = JSON.parse(sessionStorage.getItem('status_list'));
                var url = '/proxy/mode/get_emotion/status/';

                return function(status){
                    // http://api.jquery.com/jQuery.ajax/
                    // http://www.zeroedandnoughted.com/?p=185
                    $.ajax({
                        url : url,
                        type : 'post',
                        data :  {mode : 'get_motion', status : encodeURI(status['text'])},
                        dataType : 'json',
                        timeout : 20000,
                        tryCount : 0,
                        retryLimit : 3,
                        success : function(json) {
                            var emotion = json;
                            emotion_list[x] = JSON.stringify(emotion);
                            sessionStorage.setItem('emotion.' + status['key'], JSON.stringify(emotion));

                            $("#emotion_type_"+status['key']).html(emotion.body['emotion_type']);

                            // tweetリストの最後なら
                            if(x == (status_list.header['count'] - 1)){
                                sessionStorage.setItem('emotion_list', emotion_list);
                                // ローディングアニメーションstop
                                $('#loading').activity(false);
                                // メッセージ表示
                                $('#message').html('<p>' + "<?php echo $screen_name; ?>" + 'さんの、positiveをn,negativeをn,unknownをn,検知しました</p>');
                                // ツイートshareしようリンク
                                var link = "https://twitter.com/intent/tweet?text=+...+";
                                $('#lets_tweet').html('<p><a target="_brank" href="'+link+'">結果をTwitterでつぶやこう</a></p>');
                            }
                            x++;
                        },
                        error : function(xhr, textStatus, errorThrown ){
                            if(textStatus == 'timeout'){
                                this.tryCount++;
                                if(this.tryCount <= this.retryLimit){
                                    //try again
                                    $.ajax(this);
                                    return;
                                }
                                console.debug('We have tried ' + this.retryLimit + ' times and it is still not working. We give in. Sorry.');
                                return;
                            }
                            if(xhr.status == 500){
                                console.debug('Oops! 500.');
                                }else if(xhr.status == 404){
                                console.debug('Oops! 404.');
                                }else{
                                console.debug('Oops! There was a problem, sorry.');
                            }
                        }
                    });
                }
            })();
        </script>
    </body>
</html>
